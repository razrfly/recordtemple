<%= form_with url: records_path, method: :get, data: { turbo_frame: "records_list", turbo_action: "advance", controller: "sort-sync" } do |f| %>
  <input type="hidden" name="q[s]" value="<%= params.dig(:q, :s) %>" data-sort-sync-target="input">
  <%# Preserve search query when applying filters %>
  <% if params[:search].present? %>
    <input type="hidden" name="search" value="<%= params[:search] %>">
  <% end %>

  <div class="flex items-center justify-between mb-4">
    <h2 class="font-display text-lg text-olive-950">Filters</h2>
    <% if params[:q].present? || params[:has_images].present? || params[:has_audio].present? || params[:search].present? %>
      <%= link_to records_path, class: "text-sm text-olive-500 hover:text-olive-700" do %>
        Clear all
      <% end %>
    <% end %>
  </div>

  <div class="space-y-6">

    <%# Artist Autocomplete %>
    <div class="border-t border-olive-100 pt-6"
         data-controller="autocomplete"
         data-autocomplete-url-value="<%= api_artists_path %>"
         data-autocomplete-param-name-value="artist_id_in">
      <label class="block text-sm font-medium text-olive-700 dark:text-olive-300 mb-2">Artist</label>
      <div class="relative">
        <input type="text"
               data-autocomplete-target="input"
               data-action="input->autocomplete#search"
               placeholder="Search artists..."
               autocomplete="off"
               class="w-full pl-9 pr-4 py-2.5 text-sm bg-olive-50 dark:bg-olive-900 border-0 rounded-xl text-olive-900 dark:text-olive-100 placeholder-olive-400 dark:placeholder-olive-500 focus:ring-2 focus:ring-olive-500 focus:bg-white dark:focus:bg-olive-800 transition-colors">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-olive-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        <div data-autocomplete-target="results"
             class="hidden absolute z-50 mt-1 w-full bg-white dark:bg-olive-900 rounded-xl shadow-lg ring-1 ring-olive-900/5 dark:ring-olive-700 max-h-60 overflow-y-auto">
        </div>
      </div>
      <div data-autocomplete-target="selected" class="hidden flex flex-wrap gap-2 mt-3"></div>
      <div data-autocomplete-target="hiddenInputs">
        <%# Batch load artists with record counts to avoid N+1 %>
        <% artist_ids = Array(params.dig(:q, :artist_id_in)) %>
        <% if artist_ids.any? %>
          <% selected_artists = Artist.joins(:records)
               .where(id: artist_ids, records: { user_id: 1 })
               .group("artists.id")
               .select("artists.id, artists.name, COUNT(records.id) AS record_count")
               .index_by { |a| a.id.to_s } %>
          <% artist_ids.each do |artist_id| %>
            <% artist = selected_artists[artist_id.to_s] %>
            <% if artist %>
              <input type="hidden"
                     name="q[artist_id_in][]"
                     value="<%= artist.id %>"
                     data-name="<%= artist.name %>"
                     data-count="<%= artist.record_count %>">
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>

    <%# Label Autocomplete %>
    <div class="border-t border-olive-100 pt-6"
         data-controller="autocomplete"
         data-autocomplete-url-value="<%= api_labels_path %>"
         data-autocomplete-param-name-value="label_id_in">
      <label class="block text-sm font-medium text-olive-700 dark:text-olive-300 mb-2">Label</label>
      <div class="relative">
        <input type="text"
               data-autocomplete-target="input"
               data-action="input->autocomplete#search"
               placeholder="Search labels..."
               autocomplete="off"
               class="w-full pl-9 pr-4 py-2.5 text-sm bg-olive-50 dark:bg-olive-900 border-0 rounded-xl text-olive-900 dark:text-olive-100 placeholder-olive-400 dark:placeholder-olive-500 focus:ring-2 focus:ring-olive-500 focus:bg-white dark:focus:bg-olive-800 transition-colors">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-olive-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>
        <div data-autocomplete-target="results"
             class="hidden absolute z-50 mt-1 w-full bg-white dark:bg-olive-900 rounded-xl shadow-lg ring-1 ring-olive-900/5 dark:ring-olive-700 max-h-60 overflow-y-auto">
        </div>
      </div>
      <div data-autocomplete-target="selected" class="hidden flex flex-wrap gap-2 mt-3"></div>
      <div data-autocomplete-target="hiddenInputs">
        <%# Batch load labels with record counts to avoid N+1 %>
        <% label_ids = Array(params.dig(:q, :label_id_in)) %>
        <% if label_ids.any? %>
          <% selected_labels = Label.joins(:records)
               .where(id: label_ids, records: { user_id: 1 })
               .group("labels.id")
               .select("labels.id, labels.name, COUNT(records.id) AS record_count")
               .index_by { |l| l.id.to_s } %>
          <% label_ids.each do |label_id| %>
            <% label = selected_labels[label_id.to_s] %>
            <% if label %>
              <input type="hidden"
                     name="q[label_id_in][]"
                     value="<%= label.id %>"
                     data-name="<%= label.name %>"
                     data-count="<%= label.record_count %>">
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>

    <div data-controller="filter-toggle">
      <button type="button"
              data-action="click->filter-toggle#toggle"
              class="flex items-center justify-between w-full text-sm font-medium text-olive-700 mb-3">
        <span>Genre</span>
        <svg data-filter-toggle-target="icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div data-filter-toggle-target="content" class="space-y-2">
        <% @genres.first(8).each do |genre| %>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input type="checkbox"
                   name="q[genre_id_in][]"
                   value="<%= genre[:id] %>"
                   <%= "checked" if params.dig(:q, :genre_id_in)&.include?(genre[:id].to_s) %>
                   class="w-4 h-4 rounded border-olive-300 text-olive-600 focus:ring-olive-500">
            <span class="flex-1 text-sm text-olive-600 group-hover:text-olive-900 truncate"><%= genre[:name] %></span>
            <span class="text-xs text-olive-400"><%= number_with_delimiter(genre[:count]) %></span>
          </label>
        <% end %>
        <% if @genres.length > 8 %>
          <button type="button"
                  data-action="click->filter-toggle#showMore"
                  data-filter-toggle-target="showMoreBtn"
                  class="text-sm text-olive-500 hover:text-olive-700 mt-2">
            Show <%= @genres.length - 8 %> more...
          </button>
          <div data-filter-toggle-target="moreContent" class="hidden space-y-2">
            <% @genres.drop(8).each do |genre| %>
              <label class="flex items-center gap-3 cursor-pointer group">
                <input type="checkbox"
                       name="q[genre_id_in][]"
                       value="<%= genre[:id] %>"
                       <%= "checked" if params.dig(:q, :genre_id_in)&.include?(genre[:id].to_s) %>
                       class="w-4 h-4 rounded border-olive-300 text-olive-600 focus:ring-olive-500">
                <span class="flex-1 text-sm text-olive-600 group-hover:text-olive-900 truncate"><%= genre[:name] %></span>
                <span class="text-xs text-olive-400"><%= number_with_delimiter(genre[:count]) %></span>
              </label>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="border-t border-olive-100 pt-6" data-controller="filter-toggle">
      <button type="button"
              data-action="click->filter-toggle#toggle"
              class="flex items-center justify-between w-full text-sm font-medium text-olive-700 mb-3">
        <span>Format</span>
        <svg data-filter-toggle-target="icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div data-filter-toggle-target="content" class="space-y-2 hidden">
        <% @formats.each do |format| %>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input type="checkbox"
                   name="q[record_format_id_in][]"
                   value="<%= format[:id] %>"
                   <%= "checked" if params.dig(:q, :record_format_id_in)&.include?(format[:id].to_s) %>
                   class="w-4 h-4 rounded border-olive-300 text-olive-600 focus:ring-olive-500">
            <span class="flex-1 text-sm text-olive-600 group-hover:text-olive-900 truncate"><%= format[:name] %></span>
            <span class="text-xs text-olive-400"><%= number_with_delimiter(format[:count]) %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div class="border-t border-olive-100 pt-6" data-controller="filter-toggle">
      <button type="button"
              data-action="click->filter-toggle#toggle"
              class="flex items-center justify-between w-full text-sm font-medium text-olive-700 mb-3">
        <span>Condition</span>
        <svg data-filter-toggle-target="icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div data-filter-toggle-target="content" class="space-y-2 hidden">
        <% @conditions.each do |cond| %>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input type="checkbox"
                   name="q[condition_in][]"
                   value="<%= cond[:value] %>"
                   <%= "checked" if params.dig(:q, :condition_in)&.include?(cond[:value].to_s) %>
                   class="w-4 h-4 rounded border-olive-300 text-olive-600 focus:ring-olive-500">
            <span class="flex-1 text-sm text-olive-600 group-hover:text-olive-900"><%= cond[:value]&.titleize || "Unknown" %></span>
            <span class="text-xs text-olive-400"><%= number_with_delimiter(cond[:count]) %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div class="border-t border-olive-100 pt-6">
      <p class="text-sm font-medium text-olive-700 mb-3">Media</p>
      <div class="space-y-2">
        <label class="flex items-center gap-3 cursor-pointer group">
          <input type="checkbox"
                 name="has_images"
                 value="1"
                 <%= "checked" if params[:has_images] == "1" %>
                 class="w-4 h-4 rounded border-olive-300 text-olive-600 focus:ring-olive-500">
          <span class="flex-1 text-sm text-olive-600 group-hover:text-olive-900">Has Images</span>
          <span class="text-xs text-olive-400"><%= number_with_delimiter(@has_images_count) %></span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer group">
          <input type="checkbox"
                 name="has_audio"
                 value="1"
                 <%= "checked" if params[:has_audio] == "1" %>
                 class="w-4 h-4 rounded border-olive-300 text-olive-600 focus:ring-olive-500">
          <span class="flex-1 text-sm text-olive-600 group-hover:text-olive-900">
            Has Audio
            <svg class="inline w-3.5 h-3.5 ml-1 text-olive-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
          </span>
          <span class="text-xs text-olive-400"><%= number_with_delimiter(@has_audio_count) %></span>
        </label>
      </div>
    </div>

    <div class="pt-4">
      <button type="submit"
              class="w-full py-2.5 px-4 bg-olive-950 text-white text-sm font-medium rounded-xl hover:bg-olive-800 transition-colors">
        Apply Filters
      </button>
    </div>
  </div>
<% end %>
