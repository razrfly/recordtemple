<div class="mx-auto w-full max-w-2xl px-6 py-12 md:max-w-3xl lg:max-w-7xl lg:px-10" data-controller="mobile-menu">
  <header class="mb-10">
    <h1 class="font-display text-4xl tracking-tight text-olive-950 sm:text-5xl">Record Collection</h1>
    <p class="mt-3 text-lg text-olive-600">Browse <%= number_with_delimiter(@total_count) %> vinyl records</p>

    <%# Wide-net search bar %>
    <%= form_with url: records_path, method: :get, class: "mt-6", data: { turbo_frame: "records_list", turbo_action: "advance" } do |f| %>
      <%# Preserve existing filters when searching %>
      <% if params[:q].present? %>
        <% params[:q].each do |key, value| %>
          <% next if key == "artist_name_or_label_name_or_comment_cont" %>
          <% Array(value).each do |v| %>
            <input type="hidden" name="q[<%= key %>]<%= '[]' if value.is_a?(Array) %>" value="<%= v %>">
          <% end %>
        <% end %>
      <% end %>
      <% if params[:has_images].present? %>
        <input type="hidden" name="has_images" value="<%= params[:has_images] %>">
      <% end %>
      <% if params[:has_audio].present? %>
        <input type="hidden" name="has_audio" value="<%= params[:has_audio] %>">
      <% end %>

      <div class="relative max-w-2xl">
        <input type="text"
               name="search"
               value="<%= params[:search] %>"
               placeholder="Search artists, labels, genres, formats, years, notes..."
               class="w-full py-4 pr-4 text-base bg-white border border-olive-200 rounded-2xl text-olive-900 placeholder-olive-400 focus:ring-2 focus:ring-olive-500 focus:border-olive-500 shadow-sm transition-all"
               style="padding-left: 3.5rem;"
               data-controller="debounce"
               data-action="input->debounce#submit"
               data-debounce-wait-value="400">
        <svg class="absolute top-1/2 -translate-y-1/2 w-5 h-5 text-olive-400 pointer-events-none" style="left: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <% if params[:search].present? %>
          <%= link_to records_path(params.permit(:q, :has_images, :has_audio).to_h), class: "absolute right-4 top-1/2 -translate-y-1/2 p-1 text-olive-400 hover:text-olive-600 transition-colors" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          <% end %>
        <% end %>
      </div>
      <% if params[:search].present? %>
        <p class="mt-2 text-sm text-olive-600">
          Searching for "<span class="font-medium"><%= params[:search] %></span>" across all fields
        </p>
      <% end %>
    <% end %>
  </header>

  <div class="flex flex-col lg:flex-row gap-10">
    <aside class="max-lg:hidden w-72 shrink-0">
      <%= render 'records/filter_sidebar' %>
    </aside>

    <button type="button"
            data-action="click->mobile-menu#openFilters"
            class="lg:hidden flex items-center justify-center gap-2 py-3 px-4 bg-white rounded-xl shadow-sm ring-1 ring-olive-900/5 text-sm font-medium text-olive-700 hover:bg-olive-50 mb-6">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
      </svg>
      Filters
      <% if params[:q].present? || params[:has_images].present? || params[:has_audio].present? || params[:search].present? %>
        <span class="inline-flex items-center justify-center w-5 h-5 text-xs bg-olive-950 text-white rounded-full">!</span>
      <% end %>
    </button>

    <main class="flex-1">
      <%= render 'records/record_collection',
          records: @records,
          pagy: @pagy,
          filtered_count: @filtered_count,
          total_count: @total_count %>
    </main>
  </div>

  <!-- Mobile Filter Panel -->
  <div data-mobile-menu-target="backdrop"
       data-action="click->mobile-menu#closeFilters"
       class="fixed inset-0 bg-olive-950/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"></div>

  <div data-mobile-menu-target="filterPanel"
       class="fixed inset-y-0 right-0 w-full max-w-sm bg-white z-50 transform translate-x-full transition-transform duration-300 ease-out lg:hidden shadow-2xl">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b border-olive-200">
        <h2 class="font-display text-lg text-olive-950">Filters</h2>
        <button type="button"
                data-action="click->mobile-menu#closeFilters"
                class="p-2 -m-2 text-olive-500 hover:text-olive-700 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto p-4">
        <%= render 'records/filter_sidebar_content' %>
      </div>
    </div>
  </div>
</div>
